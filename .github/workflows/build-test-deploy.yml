name: build-test-deploy

on: [push, pull_request]

jobs:

# building and testing tasks

# no point in matrix without deploy tasks
# see discussion: https://github.com/orgs/community/discussions/42335

#   build-test:
#     strategy:
#       matrix:
#         os: [ubuntu-latest, windows-latest, macos-latest]
#     uses: ./.github/workflows/build-test.yml
#     with:
#       runs-on:  ${{ matrix.os }}

# passing env to jobs
# see: https://github.com/orgs/community/discussions/26671

  build-test-windows:
    uses: ./.github/workflows/build-test.yml
    with:
      runs-on: windows-latest
  build-test-linux:
    uses: ./.github/workflows/build-test.yml
    with:
      runs-on: ubuntu-latest
  build-test-macos:
    uses: ./.github/workflows/build-test.yml
    with:
      runs-on: macos-latest
      
# publishing tasks
      
  deploy-windows:
    needs: build-test-windows
    if: github.event_name == 'push'
    uses: ./.github/workflows/deploy.yml
    with:
      runs-on: windows-latest
      publish-path: 'publish'
      gh-nuget-source: 'senketsu03'
    secrets: inherit
  deploy-linux:
    needs: build-test-linux
    if: github.event_name == 'push'
    uses: ./.github/workflows/deploy.yml
    with:
      runs-on: ubuntu-latest
      publish-path: 'publish'
      gh-nuget-source: 'senketsu03'
    secrets: inherit
  deploy-macos:
    needs: build-test-macos
    if: github.event_name == 'push'
    uses: ./.github/workflows/deploy.yml
    with:
      runs-on: macos-latest
      publish-path: 'publish'
      gh-nuget-source: 'senketsu03'
    secrets: inherit
    
# Docker release -- section here

  deploy-docker-hub:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}
          
      - name: Extract docker image metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{secrets.DOCKER_USERNAME}}/deploy.cli
          
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: ${{github.event_name != 'pull_request'}}
          tags: ${{steps.meta.outputs.tags}}
          labels: ${{steps.meta.outputs.labels}}

  deploy-docker-github:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v3
        
      - name: Echo actor
        run: echo 'Actor is == ${{github.actor}}'

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: senketsu03
          password: ${{secrets.GH_PACKAGE_FEED_TOKEN}}
          
      - name: Extract docker image metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: senketsu03/deploy.cli
          
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: ${{github.event_name != 'pull_request'}}
          tags: ${{steps.meta.outputs.tags}}
          labels: ${{steps.meta.outputs.labels}}

