name: build-test-deploy

on: [push, pull_request]

jobs:

# building and testing tasks

# no point in matrix without deploy tasks
# see discussion: https://github.com/orgs/community/discussions/42335

#   build-test:
#     strategy:
#       matrix:
#         os: [ubuntu-latest, windows-latest, macos-latest]
#     uses: ./.github/workflows/build-test.yml
#     with:
#       runs-on:  ${{ matrix.os }}

# passing env to jobs
# see: https://github.com/orgs/community/discussions/26671

  build-test-windows:
    uses: ./.github/workflows/build-test.yml
    with:
      runs-on: windows-latest
    secrets: inherit
  build-test-linux:
    uses: ./.github/workflows/build-test.yml
    with:
      runs-on: ubuntu-latest
    secrets: inherit
  build-test-macos:
    uses: ./.github/workflows/build-test.yml
    with:
      runs-on: macos-latest
    secrets: inherit
      
# deploy binaries
      
  deploy-binaries-windows:
    needs: build-test-windows
    if: github.ref == 'refs/heads/master'
    uses: ./.github/workflows/deploy-binaries.yml
    with:
      runs-on: windows-latest
      publish-base: 'publish'
    secrets: inherit
  deploy-binaries-linux:
    needs: build-test-linux
    if: github.ref == 'refs/heads/master'
    uses: ./.github/workflows/deploy-binaries.yml
    with:
      runs-on: ubuntu-latest
      publish-base: 'publish'
    secrets: inherit
  deploy-binaries-macos:
    needs: build-test-macos
    if: github.ref == 'refs/heads/master'
    uses: ./.github/workflows/deploy-binaries.yml
    with:
      runs-on: macos-latest
      publish-base: 'publish'
    secrets: inherit
    
# deploy peckages

#   deploy-packages-windows:
#     needs: build-test-windows
#     if: github.ref == 'refs/heads/master'
#     uses: ./.github/workflows/deploy-packages.yml
#     with:
#       runs-on: windows-latest
#       publish-base: 'publish'
#       gh-nuget-source: ${{github.repository_owner}}
#     secrets: inherit
  deploy-packages-linux:
    needs: build-test-linux
    if: github.ref == 'refs/heads/master'
    uses: ./.github/workflows/deploy-packages.yml
    with:
      runs-on: ubuntu-latest
      publish-base: 'publish'
      gh-nuget-source: ${{github.repository_owner}}
    secrets: inherit
#   deploy-packages-macos:
#     needs: build-test-macos
#     if: github.ref == 'refs/heads/master'
#     uses: ./.github/workflows/deploy-packages.yml
#     with:
#       runs-on: macos-latest
#       publish-base: 'publish'
#       gh-nuget-source: ${{github.repository_owner}}
#     secrets: inherit
    
# Docker release -- section here

#   deploy-docker:
#     needs: build-test-linux
#     if: github.ref == 'refs/heads/master'
#     uses: ./.github/workflows/deploy-docker.yml
#     with:
#       runs-on: ubuntu-latest
#     secrets: inherit
    
  deploy-docker-new:
    needs: build-test-linux
    if: github.ref == 'refs/heads/master'
    strategy:
      matrix:
        project: ["deploy.cli"]
    uses: ./.github/workflows/deploy-docker-new.yml
    with:
      runs-on: ubuntu-latest
      registry: 'ghcr.io'
      project: ${{matrix.project}}
      project-dockerfile: 'Dockerfile'
    secrets:
      USERNAME: ${{github.repository_owner}}
      TOKEN: ${{secrets.GITHUB_TOKEN}}
    
    
